#!/usr/bin/env node
import{Command as t}from"commander";import*as n from"cheerio";const e=["bigint","int","smallint","tinyint","bit","decimal","numeric","float","real","date","time","datetime","datetime2","char","varchar","text","nchar","nvarchar","ntext","binary","varbinary","image","uniqueidentifier","xml","sql_variant","table","hierarchyid","geography","geometry"];function r(t){return t.text().replace(/[^\x20-\x7E]/g," ").replace(/[\x20]{2,}/g," ").trim()}function*i(t,n){for(const e of n)yield t(e)}async function o(t){const e=await async function(t){const e=await n.fromURL(t),r=e("noscript#fallbackPageContent").html()??"";return n.load(r)}(t.url),r=e("div.mainColumn article").children("h2"),o=new Map;for(const n of i(e,r)){const r=a(e,n);r.fields.length>0&&(r.url&&(r.url=`${t.url}#${r.url}`),o.set(r.name,r))}return o}function a(t,n){const e=n.data("id"),o=[],a=[],l=n.nextUntil("h2");for(const n of i(t,l))if(n.is("table"))0===a.length&&a.push(...c(t,n));else{const t=r(n);t.length>0&&o.push(t)}return{name:r(n),url:"string"==typeof e?e:void 0,versions:s(a),description:o.join(" ").trim(),keys:a.filter(t=>t.isPrimary).map(t=>t.name),fields:a}}function c(t,n){const e=[];for(const o of function*(t,n){const e=[];for(const o of i(t,n.find("thead th")))e.push(r(o));for(const o of i(t,n.find("tbody tr"))){const n=new Map;let a=-1;for(const c of i(t,o.find("td")))++a<e.length&&n.set(e[a],r(c));yield n}}(t,n)){const t=l(o.get("Version History")??""),n=o.get("Field"),r=u(o.get("Type")??""),i=o.get("Description")??"",a=o.get("Key")??"";t&&n&&r&&e.push({version:t,name:n,description:i,type:r,format:o.get("Size")??"",isPrimary:a.includes("PK"),isForeign:a.includes("FK"),canBeNull:i.includes("can be null")})}return e}function s(t){return[...new Set(t.map(t=>t.version.id))].sort((t,n)=>{const[e,r]=[...t.split(".").map(t=>parseInt(t)),0,0],[i,o]=[...n.split(".").map(t=>parseInt(t)),0,0];return e!==i?e-i:r-o})}function l(t){const n=t?.match(/^([0-9]+\.[0-9]+)(?:[ ]*\/[ ]*([0-9]+\.[0-9]+))?(?:[ ]*-[ ]*(.*))?/)??null;return n?{id:n[2]??n[1]??"",description:n[3]??""}:void 0}function u(t){const n=e.find(n=>n===t);return n||void 0}function f(t){return"object"==typeof t&&null!==t&&!Array.isArray(t)}function d(t){return"object"==typeof t&&null!==t&&Array.isArray(t)}async function p(t){const e=function(t){const n=t("head > script:first").text(),e=new Function(`"use strict"; const window = {}; ${n}; return window?.__ACTIONS__;`)();return d(e)?e.filter(f):[]}(await n.fromURL(t)),r=function(t,n){const e=t.find(t=>"type"in t&&t.type===n)??{},r="payload"in e&&f(e.payload)?e.payload:{};return"result"in r&&d(r.result)?r.result.filter(t=>f(t)):[]}(e,"@@navigation/GET_NAVIGATION_FLAT_DONE");return r.filter(t=>function(t){const n=f(t)?t:{};return"name"in n&&"string"==typeof n?.name&&"url"in n&&"string"==typeof n?.url&&"parentID"in n&&"number"==typeof n?.parentID&&"recordID"in n&&"number"==typeof n?.recordID&&"sort"in n&&"number"==typeof n?.sort&&"knowledgeBaseID"in n&&"number"==typeof n?.knowledgeBaseID&&"recordType"in n&&"string"==typeof n?.recordType}(t))}async function m(){const t=await p("https://community.d2l.com/brightspace/kb/articles/4518-about-brightspace-data-sets"),n=t.find(t=>"Brightspace Data Sets"===t.name)?.recordID??-99;return t.filter(t=>t.parentID===n&&"article"===t.recordType).map(t=>({name:t.name.replace(" data sets",""),url:t.url}))}function y(t,n){return n instanceof Map?Object.fromEntries(n):n}async function g(){const t=await m();for(const n of t)console.log(n.name)}async function h(t){const n=(await m()).filter(n=>void 0===t||t===n.name),e=await Promise.all(n.map(t=>async function(t){const n=await o(t);return{...t,datasets:n}}(t)));var r;console.log((r=e,JSON.stringify(r,y,2)))}var b;b=process.argv,function(){const n=new t;return n.command("list").description("Lists available BDS categories").action(g),n.command("get [categoryName]").description("Get schema for specified category").action(h),n}().parse(b);
